{# templates/results/results.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Results / Participation{% endblock %}

{% block extra_css %}
  <!-- page-specific small styles (prefer moving these to a CSS file) -->
  <style>
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px; border-bottom:1px solid #ddd; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; }
    .modal.open { display:flex; }
    .panel { background:white; padding:20px; border-radius:6px; width:450px; }
  </style>
{% endblock %}

{% block content %}
  <h2>Results / Participation</h2>

  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Bib</th>
        <th>Category</th>
        <th>Gender</th>
        <th>Total Lap Time</th>
        <th>End Time</th>
        <th>Participated</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for entry in entries %}
      <tr data-start-id="{{ entry.id }}">
        <td>{{ entry.name }}</td>
        <td>{{ entry.bib_id }}</td>


        <td class="age_group_cell">{{ entry.category_display }}</td>


        <td class="gender_cell">
          {% if entry.participation %}{{ entry.participation.gender }}{% else %}{{ entry.gender }}{% endif %}
        </td>

        <td class="lap_time_cell">
          {% if entry.participation and entry.participation.total_lap_time %}
            {{ entry.participation.total_lap_time }}
          {% elif entry.total_lap_time %}
            {{ entry.total_lap_time }}
          {% else %}
            -
          {% endif %}
        </td>

        <td class="end_time_cell">
          {% if entry.participation and entry.participation.end_time_mmss %}
            {{ entry.participation.end_time_mmss }}
          {% endif %}
        </td>

        <td>
          <input class="is-participated-checkbox" type="checkbox"
            {% if entry.participation and entry.participation.is_participated %}checked{% endif %}>
        </td>

        <td>
          <button type="button" class="edit-btn btn btn-outline-secondary">Edit</button>
        </td>

      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Modal -->
  <div id="editModal" class="modal">
    <div class="panel">
      <h3>Edit Participation</h3>

      <form id="participationForm">
        <input type="hidden" id="startEntryId">

        <label>Gender<br>
          <select id="f_gender">
            <option value=""></option>
            <option>Male</option>
            <option>Female</option>
            <option>Other</option>
          </select>
        </label><br><br>

        <label>Total lap time (seconds)<br>
          <input id="f_total_lap_time_seconds" type="number" step="0.01" min="0">
        </label><br><br>

        <label>End time (MM:SS)<br>
          <input id="f_end_time_mmss" placeholder="MM:SS or H:MM:SS">
        </label><br><br>

        <button type="submit">Save</button>
        <button type="button" id="modalClose">Cancel</button>
      </form>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
(function(){

  function getCookie(name){
    let cookieValue = null;
    if(document.cookie){
      const cookies=document.cookie.split(';');
      for(const c of cookies){
        const cookie=c.trim();
        if(cookie.startsWith(name + '=')){
          cookieValue=decodeURIComponent(cookie.split('=')[1]);
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  // checkbox toggle
  document.querySelectorAll(".is-participated-checkbox").forEach(cb=>{
    cb.addEventListener("change", async e=>{
      const tr = e.target.closest("tr");
      const id = tr.dataset.startId;
      const payload = { is_participated: e.target.checked };
      const url = "{% url 'app_results:update' 0 %}".replace("/0/", `/${id}/`);
      try {
        await fetch(url,{
          method:"POST",
          headers:{ "Content-Type":"application/json", "X-CSRFToken":csrftoken },
          body: JSON.stringify(payload)
        });
      } catch (err){
        console.error("Participation toggle failed", err);
      }
    });
  });

  // modal behavior
  const modal = document.getElementById("editModal");
  const form = document.getElementById("participationForm");

  document.querySelectorAll(".edit-btn").forEach(btn=>{
    btn.addEventListener("click", e=>{
      const tr = e.target.closest("tr");
      const id = tr.dataset.startId;
      document.getElementById("startEntryId").value = id;
      document.getElementById("f_gender").value = tr.querySelector(".gender_cell").innerText.trim() || "";
      document.getElementById("f_total_lap_time_seconds").value = "";
      document.getElementById("f_end_time_mmss").value = tr.querySelector(".end_time_cell").innerText.trim() || "";
      modal.classList.add("open");
    });
  });

  document.getElementById("modalClose").addEventListener("click", ()=>{
    modal.classList.remove("open");
  });

  // submit modal
  form.addEventListener("submit", async e=>{
    e.preventDefault();
    const id = document.getElementById("startEntryId").value;
    const lapInput = document.getElementById("f_total_lap_time_seconds").value;
    const lapVal = lapInput === "" ? null : Number(lapInput);
    const endMmss = document.getElementById("f_end_time_mmss").value || null;

    const payload = {
      gender: document.getElementById("f_gender").value || null,
      total_lap_time_seconds: lapVal,
      end_time_mmss: endMmss
    };

    const url = "{% url 'app_results:update' 0 %}".replace("/0/", `/${id}/`);
    let res;
    try {
      res = await fetch(url,{
        method:"POST",
        headers:{ "Content-Type":"application/json", "X-CSRFToken":csrftoken },
        body: JSON.stringify(payload)
      });
    } catch (err){
      console.error("Save failed", err);
      modal.classList.remove("open");
      return;
    }

    if (!res.ok){
      console.error("Save failed", await res.text());
      modal.classList.remove("open");
      return;
    }

    const data = await res.json();

    if (data.ok){
      const tr = document.querySelector(`tr[data-start-id='${id}']`);
      tr.querySelector(".gender_cell").innerText = data.gender || "";
      tr.querySelector(".end_time_cell").innerText = data.end_time_mmss || "";

      const lapCell = tr.querySelector(".lap_time_cell");
      if (data.total_lap_time_display){
        lapCell.innerText = data.total_lap_time_display;
      } else if (data.total_lap_time_seconds !== null && data.total_lap_time_seconds !== undefined){
        lapCell.innerText = Number(data.total_lap_time_seconds).toString();
      } else {
        lapCell.innerText = "-";
      }
    }

    modal.classList.remove("open");
  });

})();
</script>
{% endblock %}
