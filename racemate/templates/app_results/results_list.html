{% extends "base.html" %}
{% load static %}

{% block title %}Results / Participation{% endblock %}

{% block extra_css %}
<link href="{% static 'css/base.css' %}" rel="stylesheet">
<style>
  table { width:100%; border-collapse:collapse; }
  th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; }
  .modal.open { display:flex; }
  .panel { background:#fff; padding:16px; border-radius:8px; width:480px; max-width:95%; }
</style>
{% endblock %}

{% block content %}
  <h1>Results / Participation</h1>

  <!-- pass the url template for the update view to JS using a data-attribute -->
  <div id="page" data-update-url-template="{% url 'app_results:update' 0 %}">
    <table>
      <thead>
        <tr>
          <th>Rider</th>
          <th>Bib</th>
          <th>Age group</th>
          <th>Gender</th>
          <th>Total Lap Time</th>
          <th>End Time</th>
          <th>Participated</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in entries %}
        <tr data-start-id="{{ entry.pk }}">
          <td>{{ entry.name }}</td>
          <td>{{ entry.bib_id }}</td>
          <td class="age_group_cell">{% if entry.participation %}{{ entry.participation.age_group }}{% endif %}</td>
          <td class="gender_cell">{% if entry.participation %}{{ entry.participation.gender }}{% else %}{{ entry.gender }}{% endif %}</td>
          <td class="lap_time_cell">
            {% if entry.total_lap_time %}
              {{ entry.total_lap_time }}
            {% else %}
              -
            {% endif %}
          </td>
          <td class="end_time_cell">{% if entry.participation %}{{ entry.participation.end_time }}{% endif %}</td>
          <td>
            <input class="is-participated-checkbox" type="checkbox" {% if entry.participation and entry.participation.is_participated %}checked{% endif %} />
          </td>
          <td><button class="edit-btn">Edit</button></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Modal -->
    <div id="editModal" class="modal" aria-hidden="true">
      <div class="panel">
        <h3>Edit Participation</h3>
        <form id="participationForm">
          <input type="hidden" id="startEntryId">
          <label>Age group<br><input id="f_age_group"></label><br>
          <label>Gender<br>
            <select id="f_gender">
              <option value=""></option>
              <option>Male</option>
              <option>Female</option>
              <option>Other</option>
            </select>
          </label><br>
          <label>Total lap time (seconds)<br><input id="f_total_lap_time_seconds" type="number" /></label><br>
          <label>End time (ISO)<br><input id="f_end_time" placeholder="YYYY-MM-DDThh:mm:ss" /></label><br><br>
          <button type="submit">Save</button>
          <button type="button" id="modalClose">Cancel</button>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <!-- external JS file -->
  <script src="{% static 'js/participation.js' %}"></script>
{% endblock %}
